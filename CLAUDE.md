# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This repository contains tooling for creating hybrid Raspberry Pi images that combine Raspberry Pi OS boot/firmware with custom Debian ARM64 root filesystems. The primary use case is running Debian on Raspberry Pi 5 hardware while maintaining full hardware support (RP1 chip drivers for Ethernet, GPIO, USB, etc.).

## Architecture

The project uses a partition-level merge approach:

1. **Boot partition (FAT32)**: Retained from Raspberry Pi OS to ensure Pi 5 firmware compatibility
2. **Root partition (ext4)**: Replaced with custom Debian ARM64 rootfs
3. **Critical components preserved from RaspiOS**:
   - `/boot/firmware` - Pi bootloader and config files
   - `/lib/modules` - RaspiOS kernel modules (including RP1 drivers)
   - `/lib/firmware` - Hardware firmware blobs
   - `/etc/fstab` - Partition mount configuration
   - `/boot/*` - Kernel and initramfs (unless `--keep-kernel` is used)

The merge strategy ensures hardware compatibility while allowing a completely custom userspace.

## Key Commands

### Multi-Image Management

The project supports multiple image configurations. Each image is defined in `images/<name>/`:

```bash
# List available images
./bin/autobuild --list-images

# Build a specific image
./bin/autobuild --image exemple

# Build all images
./bin/autobuild --all-images
```

Each image directory contains:
- `config.sh` - Build configuration (OUTPUT_IMAGE, IMAGE_SIZE, QEMU_RAM, QEMU_CPUS, DESCRIPTION)
- `setup.sh` - Setup script executed in QEMU during build
- `setupfiles/` - Files copied to `/root/setupfiles/` in the final image
- `cloudinit/` - Cloud-init configuration specific to this image (user-data, meta-data, seed.img auto-generated)

### Automated Build Process

The `autobuild` script automates the entire workflow:

1. Downloads base images (RaspiOS + Debian)
2. Creates `setup.iso` from the image's setup.sh and setupfiles/
3. Launches QEMU with cloud-init + setup.iso
4. Waits for automatic setup completion and poweroff
5. Merges RaspiOS boot with Debian rootfs
6. Compresses with PiShrink

Common options:
- `--image NAME` - Build specific image
- `--all-images` - Build all images
- `--skip-download` - Use existing base images
- `--skip-qemu` - Skip QEMU setup (use existing Debian image)
- `--skip-compress` - Skip PiShrink compression

Examples:
```bash
# Build the exemple image
./bin/autobuild --image exemple

# Build all images without re-downloading base images
./bin/autobuild --all-images --skip-download

# Quick rebuild without QEMU setup
./bin/autobuild --image exemple --skip-qemu --skip-compress
```

### Creating a New Image

```bash
# 1. Copy exemple image
cp -r images/exemple images/myimage

# 2. Edit config
vim images/myimage/config.sh
# Set OUTPUT_IMAGE, IMAGE_SIZE, QEMU_RAM, QEMU_CPUS, DESCRIPTION

# 3. Customize setup
vim images/myimage/setup.sh
# Add package installations, configuration, etc.

# 4. Add custom files
cp my-config.txt images/myimage/setupfiles/

# 5. Build
./bin/autobuild --image myimage
```

### Manual Merge (Low-Level)

For direct control without autobuild:

```bash
./bin/merge-debian-raspios.sh <raspios-image> <debian-image>
```

Common options:
- `-o, --output FILE` - Output image name (default: `hybrid-debian-raspios.img`)
- `-s, --size SIZE` - Final image size (default: auto-calculated as Debian size + 1-2GB)
- `-k, --keep-kernel` - Use Debian kernel instead of RaspiOS kernel (not recommended - RP1 drivers missing)

Examples:
```bash
# Basic merge
./bin/merge-debian-raspios.sh 2025-11-24-raspios-trixie-arm64-lite.img debian-13-backports-genericcloud-arm64-daily.raw

# Custom output and size
./bin/merge-debian-raspios.sh -o pi5-custom.img -s 16G raspios-lite.img debian.raw
```

### Flashing to SD Card/SSD

```bash
sudo dd if=hybrid-debian-raspios.img of=/dev/sdX bs=4M status=progress conv=fsync
sync
```

### Compressing Images

```bash
sudo pishrink.sh -z hybrid-debian-raspios.img hybrid-debian-raspios.img.xz
```

## Cloud-Init Configuration

Each image has its own `cloudinit/` directory under `images/<name>/cloudinit/`:

- `user-data` - Cloud-init user configuration (user creation, SSH keys, passwords)
- `meta-data` - Instance metadata (hostname, instance ID)
- `seed.img` - ISO 9660 filesystem containing user-data and meta-data (auto-generated by autobuild)

The `seed.img` is automatically regenerated during the build process. To manually regenerate:
```bash
genisoimage -output images/<name>/cloudinit/seed.img -volid cidata -joliet -rock \
    images/<name>/cloudinit/user-data \
    images/<name>/cloudinit/meta-data
```

## Technical Constraints

### Why RaspiOS Kernel is Required

Raspberry Pi 5 uses the RP1 southbridge chip for critical I/O (Ethernet, USB, GPIO). The RP1 drivers are only available in the Raspberry Pi kernel tree and are not yet upstream in mainline Linux. Using the Debian kernel (`--keep-kernel`) will result in:
- No Ethernet connectivity
- Limited USB functionality
- No GPIO access
- Missing hardware accelerators

### Partition Layout Assumptions

The merge script expects:
- **RaspiOS image**: 2-partition layout (boot FAT32 + root ext4)
- **Debian image**: Either single partition or 2-partition layout where rootfs is on p1 or p2
- Auto-detection logic in `merge-debian-raspios.sh:222-228`

### Image Format Support

- **Input formats**: `.img`, `.img.xz` (RaspiOS), `.raw`, `.qcow2` (Debian - auto-converted)
- **Output format**: Always `.img` (raw disk image)
- Uses `qemu-img` for format detection and conversion

## Dependencies

Required packages (Debian/Ubuntu):
```bash
sudo apt install -y parted e2fsprogs dosfstools qemu-utils rsync xz-utils genisoimage
```

## GitHub Actions CI/CD

The project includes automated builds via GitHub Actions (`.github/workflows/build-images.yml`):

- **Triggers**: Push to any branch, daily at 2:00 UTC, manual dispatch
- **Process**: Downloads base images, builds all images, creates releases
- **Releases**:
  - `main` branch → stable releases
  - Other branches → pre-releases
  - Tag format: `vYYYY-MM-DD-HHMM`
- **Assets**: All `.img.xz` files uploaded to GitHub Releases

See `.github/README.md` for detailed workflow documentation.

## Merge Process Stages

The merge script follows this 10-stage process:

1. Dependency verification
2. RaspiOS image preparation (decompress if `.xz`)
3. Debian image preparation (convert to raw if needed)
4. Size analysis and calculation
5. Output image creation (copy of RaspiOS)
6. Image resizing and partition expansion
7. Loop device mounting (both images)
8. Backup of RaspiOS critical files
9. Rootfs replacement (delete RaspiOS root, rsync Debian root)
10. Restoration and cleanup

Critical paths during merge:
- All operations use loop devices (`losetup -P`)
- Partition resizing uses `parted` + `resize2fs`
- Rootfs copy uses `rsync -aAXv` to preserve all attributes
- Temporary mounts use PID-based naming to avoid conflicts

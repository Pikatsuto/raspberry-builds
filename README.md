# Raspberry Pi - Hybrid Debian ARM64 Image

## Project Description

This project creates hybrid images for Raspberry Pi (ARM64) combining:
- **Raspberry Pi OS Boot/Firmware**: For complete Raspberry Pi hardware compatibility
- **Custom Debian ARM64 Rootfs**: For a pure Debian system

The goal is to work around the limitations of the standard Debian kernel which doesn't yet support all Raspberry Pi hardware features while maintaining a complete Debian environment. This is especially important for Raspberry Pi which uses the RP1 chip for critical I/O.

### Why This Approach?

The Raspberry Pi kernel includes drivers for all Raspberry Pi hardware (including the **RP1** chip on Pi for Ethernet, USB, GPIO). These drivers are not yet integrated into the mainline Linux kernel. This solution allows you to:

‚úÖ Keep full Raspberry Pi hardware support (Ethernet, WiFi, GPIO, USB)
‚úÖ Use a pure Debian rootfs with your custom configurations
‚úÖ Leverage cloud-init for automatic initialization
‚úÖ Develop and test in QEMU before flashing to SD card

## Prerequisites

### Required Packages

```bash
sudo apt install -y \
    qemu-system-aarch64 \
    qemu-utils \
    qemu-efi-aarch64 \
    parted \
    e2fsprogs \
    dosfstools \
    rsync \
    xz-utils \
    genisoimage
```

### Base Images

1. **Raspberry Pi OS Lite ARM64**:
   ```bash
   wget https://downloads.raspberrypi.com/raspios_lite_arm64/images/raspios_lite_arm64-2025-11-24/2025-11-24-raspios-trixie-arm64-lite.img.xz
   xz -d 2024-11-19-raspios-bookworm-arm64-lite.img.xz
   ```

2. **Debian ARM64 Generic Cloud**:
   ```bash
   wget https://cloud.debian.org/images/cloud/trixie-backports/daily/latest/debian-13-backports-genericcloud-arm64-daily.raw
   # Or use the .raw file directly if available
   ```

## Automated Multi-Image Build (Recommended)

### Multi-Image Management

This project supports multiple image configurations. Each image has its own folder in `images/`:

```bash
# List available images
./bin/autobuild --list-images

# Build a specific image
./bin/autobuild --image exemple

# Build all images
./bin/autobuild --all-images
```

### Autobuild Mode - All in One Command

**This script automatically performs:**

1. ‚úì Download RaspiOS and Debian images
2. ‚úì Create `setup.iso` with your configuration script
3. ‚úì Launch QEMU with cloud-init
4. ‚úì Automatic setup execution (package installation, configuration)
5. ‚úì Automatic QEMU shutdown
6. ‚úì Create hybrid Raspberry Pi image
7. ‚úì Compress with PiShrink (.xz)

**Result**: A ready-to-flash `rpi-XXX.img.xz` image!

### Autobuild Script Options

```bash
# List available images
./bin/autobuild --list-images

# Build a specific image
./bin/autobuild --image exemple

# Build all images at once
./bin/autobuild --all-images

# Skip download (use existing images)
./bin/autobuild --image exemple --skip-download

# Skip QEMU (use already configured Debian image)
./bin/autobuild --image exemple --skip-qemu

# Skip PiShrink compression
./bin/autobuild --image exemple --skip-compress

# Full help
./bin/autobuild --help
```

### Creating a New Image

1. **Copy the example image**
   ```bash
   cp -r images/exemple images/my-image
   ```

2. **Modify the configuration** (`images/my-image/config.sh`)
   ```bash
   OUTPUT_IMAGE="rpi-my-image.img"
   IMAGE_SIZE="16G"
   QEMU_RAM="8G"
   QEMU_CPUS="4"
   DESCRIPTION="My awesome custom image"
   ```

3. **Customize the setup** (`images/my-image/setup.sh`)
   - Add your packages
   - Configure your services
   - Customize the system

4. **Add your files** (`images/my-image/setupfiles/`)
   - Configurations (.bashrc, .vimrc, etc.)
   - Scripts
   - SSH keys, certificates

5. **Build the image**
   ```bash
   ./bin/autobuild --image my-image
   ```

### Image Structure

Each image in `images/` contains:

```
images/image-name/
‚îú‚îÄ‚îÄ config.sh       # Configuration (OUTPUT_IMAGE, IMAGE_SIZE, RAM, CPUs)
‚îú‚îÄ‚îÄ setup.sh        # Script executed at boot in QEMU
‚îú‚îÄ‚îÄ setupfiles/     # Files copied to /root/setupfiles/ in the image
‚îî‚îÄ‚îÄ cloudinit/      # Cloud-init configuration specific to this image
    ‚îú‚îÄ‚îÄ user-data   # Users, SSH, passwords
    ‚îú‚îÄ‚îÄ meta-data   # Hostname, instance-id
    ‚îî‚îÄ‚îÄ seed.img    # Automatically generated by autobuild
```

### Pre-built Images

This repository includes several ready-to-use images:

#### RaspiVirt-Incus
**Image**: `raspivirt-incus`

A complete virtualization platform with Incus container/VM manager:
- Incus web UI (port 8443)
- KVM hardware virtualization
- Bridged networking (br-wan)
- System containers and VMs support

```bash
./bin/autobuild --image raspivirt-incus
```

#### RaspiVirt-Incus+Docker
**Image**: `raspivirt-incus+docker`

Extends RaspiVirt-Incus with Docker integration:
- Everything from RaspiVirt-Incus
- Docker Engine with Incus bridge networking
- Run both containers and VMs on the same host

```bash
./bin/autobuild --image raspivirt-incus+docker
```

#### RaspiVirt-Incus+HAOS
**Image**: `raspivirt-incus+haos`

Home automation platform with automatic Home Assistant OS deployment:
- Everything from RaspiVirt-Incus
- Home Assistant OS 16.3 VM (auto-deployed on first boot)
- Adaptive dual-bridge networking (br-lan/br-wan)
- Automatic Zigbee dongle detection and USB passthrough
- Built-in DHCP server for internal LAN (if eth1 detected)

```bash
./bin/autobuild --image raspivirt-incus+haos
```

### Custom Image Examples

#### Docker Image
```bash
cp -r images/exemple images/docker
# Edit images/docker/setup.sh to add Docker
./bin/autobuild --image docker
```

#### Web Server Image
```bash
cp -r images/exemple images/webserver
# Edit images/webserver/setup.sh to install Nginx
./bin/autobuild --image webserver
```

See `images/README.md` for more details.

## Manual Development Workflow

### 1. Development and Testing in QEMU

Before creating the final Raspberry Pi image, you can develop and test your Debian configuration in QEMU.

#### Launch Debian Image in QEMU

```bash
# Launch QEMU with cloud-init
qemu-system-aarch64 \
    -M virt \
    -cpu cortex-a72 \
    -m 8G \
    -smp 4 \
    -bios /usr/share/edk2/aarch64/QEMU_CODE.fd \
    -drive file=debian-13-backports-genericcloud-arm64-daily.raw,format=raw,if=virtio \
    -drive file=cloudinit/seed.img,format=raw,if=virtio \
    -device virtio-net-pci,netdev=net0 \
    -netdev user,id=net0,hostfwd=tcp::2222-:22 \
    -nographic
```

#### Important QEMU Options

- `-M virt`: Generic ARM virtual machine
- `-cpu cortex-a72`: ARM Cortex-A72 processor (similar to Pi)
- `-m 8G`: 8 GB RAM
- `-smp 4`: 4 CPU cores
- `-bios`: UEFI firmware for ARM64
- `hostfwd=tcp::2222-:22`: Forward SSH from port 2222 (host) to 22 (VM)
- `-nographic`: Console mode (no graphical interface)

#### Connect to the VM

```bash
# Via SSH (once the VM has started)
ssh -p 2222 pi@localhost

# Default password (defined in cloudinit/user-data)
# User: pi
# Password: raspberry
```

#### Modify Cloud-init Configuration

If you need to modify the cloud-init configuration:

```bash
# 1. Edit the files
nano cloudinit/user-data    # User configuration, SSH keys, etc.
nano cloudinit/meta-data    # Hostname, instance-id

# 2. Recreate the seed.img image
genisoimage -output cloudinit/seed.img \
    -volid cidata \
    -joliet -rock \
    cloudinit/user-data \
    cloudinit/meta-data

# 3. Relaunch QEMU with the new configuration
```

#### Customize the Debian Rootfs

Once in the QEMU VM, you can install packages and configure the system:

```bash
# Connect to the VM
ssh -p 2222 pi@localhost

# Install your packages
sudo apt update
sudo apt install -y vim git htop docker.io python3-pip

# Configure your services
# ...

# Shut down the VM
sudo poweroff
```

The `debian-13-arm64.raw` image now contains your customizations.

### 2. Creating the Hybrid Image for Raspberry Pi

Once your Debian rootfs is configured and tested, create the final image for Raspberry Pi:

```bash
unxz 2025-11-24-raspios-trixie-arm64-lite.img.xz

./bin/merge-debian-raspios.sh \
    -o rpi-hybrid.img \
    -s 8G \
    2025-11-24-raspios-trixie-arm64-lite.img \
    debian-13-backports-genericcloud-arm64-daily.raw
```

#### Available Options

- `-o, --output FILE`: Output image name (default: `hybrid-debian-raspios.img`)
- `-s, --size SIZE`: Final image size (default: auto = Debian size + 1-2GB)
  - Examples: `8G`, `16G`, `4096M`
- `-k, --keep-kernel`: **NOT RECOMMENDED** - Keep Debian kernel (RP1 won't work)
- `-h, --help`: Display help

#### What Does the Merge Script Do?

The script performs the following operations:

1. ‚úì Decompress RaspiOS image if necessary (.xz)
2. ‚úì Convert Debian image to raw format if necessary (qcow2, etc.)
3. ‚úì Create output image based on RaspiOS
4. ‚úì Resize image to desired size
5. ‚úì Backup critical RaspiOS components:
   - Kernel and modules (`/lib/modules`)
   - Hardware firmware (`/lib/firmware`)
   - Boot configuration (`/boot/firmware`)
   - Partition table (`/etc/fstab`)
6. ‚úì Completely replace rootfs with your Debian
7. ‚úì Restore backed-up RaspiOS components
8. ‚úì Clean up and finalize the image

**Result**: A bootable image with the RaspiOS kernel but Debian userspace.

### 3. Image Compression with PiShrink

The created image occupies the full specified size (e.g., 8GB). To reduce it before distribution:

#### Installing PiShrink

```bash
wget https://raw.githubusercontent.com/Drewsif/PiShrink/master/pishrink.sh
chmod +x pishrink.sh
sudo mv pishrink.sh /usr/local/bin/
```

#### Using PiShrink

```bash
# Shrink the image (removes empty space)
sudo pishrink.sh rpi-hybrid.img

# Shrink and compress to .xz in one step
sudo pishrink.sh -Z rpi-hybrid.img

# Result: rpi-hybrid.img.xz (much smaller)
```

#### Useful PiShrink Options

- `-z`: Compress image to .xz after shrinking
- `-a`: Compress to .gz instead of .xz (faster, less compact)
- `-v`: Verbose mode (show details)

**Example savings**: An 8GB image can be reduced to ~2GB after PiShrink, then ~800MB after .xz compression.

### 4. Flashing the Image to SD Card

#### With uncompressed image

```bash
sudo dd if=rpi-hybrid.img of=/dev/sdX bs=4M status=progress conv=fsync
sync
```

#### With compressed image (.xz)

```bash
# Decompress and flash in one command
xz -dc rpi-hybrid.img.xz | sudo dd of=/dev/sdX bs=4M status=progress conv=fsync
sync
```

**‚ö†Ô∏è WARNING**: Replace `/dev/sdX` with the correct device (verify with `lsblk`)

#### Verify the Device

```bash
# List disks
lsblk

# Example output:
# NAME   MAJ:MIN RM   SIZE RO TYPE MOUNTPOINTS
# sda      8:0    0 238.5G  0 disk
# ‚îú‚îÄsda1   8:1    0   512M  0 part /boot
# ‚îî‚îÄsda2   8:2    0   238G  0 part /
# sdb      8:16   1  29.7G  0 disk    <- Your SD card
# ‚îî‚îÄsdb1   8:17   1  29.7G  0 part
```

## Complete Workflow Summary

```bash
# 1. Develop and test in QEMU
qemu-system-aarch64 -M virt -cpu cortex-a72 -m 8G -smp 4 \
    -bios /usr/share/edk2/aarch64/QEMU_CODE.fd \
    -drive file=debian-13-backports-genericcloud-arm64-daily.raw,format=raw,if=virtio \
    -drive file=cloudinit/seed.img,format=raw,if=virtio \
    -device virtio-net-pci,netdev=net0 \
    -netdev user,id=net0,hostfwd=tcp::2222-:22 \
    -nographic

# 2. Customize via SSH
ssh -p 2222 pi@localhost

# 3. Create hybrid Raspberry Pi image
./bin/merge-debian-raspios.sh \
    -o rpi-custom.img -s 8G \
    2025-11-24-raspios-trixie-arm64-lite.img \
    debian-13-arm64.raw

# 4. Shrink and compress
sudo pishrink.sh -z rpi-custom.img

# 5. Flash to SD
xz -dc rpi-custom.img.xz | sudo dd of=/dev/sdX bs=4M status=progress conv=fsync
sync

# 6. Insert SD into Raspberry Pi and boot!
```

## Project Structure

```
rpi-dev/
‚îú‚îÄ‚îÄ bin/
‚îÇ   ‚îú‚îÄ‚îÄ autobuild                      # üöÄ Automated multi-image build script
‚îÇ   ‚îî‚îÄ‚îÄ merge-debian-raspios.sh        # RaspiOS + Debian merge script
‚îú‚îÄ‚îÄ images/                            # üìÅ Custom images folder
‚îÇ   ‚îú‚îÄ‚îÄ README.md                      # Image creation guide
‚îÇ   ‚îî‚îÄ‚îÄ exemple/
‚îÇ       ‚îú‚îÄ‚îÄ config.sh                  # Image configuration
‚îÇ       ‚îú‚îÄ‚îÄ setup.sh                   # Setup script executed in QEMU
‚îÇ       ‚îú‚îÄ‚îÄ setupfiles/                # Files copied to the image
‚îÇ       ‚îî‚îÄ‚îÄ cloudinit/                 # Cloud-init configuration for this image
‚îÇ           ‚îú‚îÄ‚îÄ user-data              # Users, SSH, passwords
‚îÇ           ‚îú‚îÄ‚îÄ meta-data              # Hostname, instance-id
‚îÇ           ‚îî‚îÄ‚îÄ seed.img               # Automatically generated
‚îú‚îÄ‚îÄ 2025-11-24-raspios-trixie-arm64-lite.img  # RaspiOS image (downloaded)
‚îú‚îÄ‚îÄ debian-13-backports-genericcloud-arm64-daily.raw  # Debian image (downloaded)
‚îú‚îÄ‚îÄ debian-13-arm64.raw                # Working copy of Debian image
‚îú‚îÄ‚îÄ setup.iso                          # ISO containing setup + setupfiles (generated)
‚îú‚îÄ‚îÄ rpi-*.img                          # Final hybrid images (generated)
‚îú‚îÄ‚îÄ rpi-*.img.xz                       # Compressed ready-to-flash images (generated)
‚îú‚îÄ‚îÄ CLAUDE.md                          # Technical documentation for Claude Code
‚îî‚îÄ‚îÄ README.md                          # This file
```

## Supported Features on Raspberry Pi

With this approach, you get:

‚úÖ **Gigabit Ethernet** (via RP1)
‚úÖ **WiFi** (BCM43455)
‚úÖ **Bluetooth**
‚úÖ **GPIO** (40 pins)
‚úÖ **USB 3.0** (via RP1)
‚úÖ **PCIe** (for M.2 SSD)
‚úÖ **HDMI** (dual 4K)
‚úÖ **Camera/DSI/CSI**
‚úÖ **Hardware acceleration** (VideoCore VII)

## Troubleshooting

### QEMU Won't Start

```bash
# Check that UEFI firmware is installed
ls /usr/share/edk2/aarch64/QEMU_CODE.fd

# If missing, install:
sudo apt install qemu-efi-aarch64
```

### Raspberry Pi Image Won't Boot

- Verify you **did not** use the `--keep-kernel` option
- The RaspiOS kernel is **required** for RP1 support
- Verify the SD card was properly flashed with `sync`

### No Network Connection on Raspberry Pi

- If you used `--keep-kernel`, the RP1 drivers are not loaded
- Recreate the image **without** `--keep-kernel`

### Image Is Too Large

- Use PiShrink to reduce unused space
- Specify a smaller image size with `-s` (e.g., `-s 4G`)

## Automated Releases via GitHub Actions

This project uses GitHub Actions to automatically build all images and create releases.

### Download Pre-built Images

Instead of building yourself, download images from [Releases](../../releases):

1. Go to the **Releases** tab
2. Download the desired `.img.xz` image
3. Flash directly to your SD card

```bash
# Download from release (example)
wget https://github.com/YOUR_USERNAME/rpi-dev/releases/download/v2025-01-15/rpi-exemple.img.xz

# Flash
xz -dc rpi-exemple.img.xz | sudo dd of=/dev/sdX bs=4M status=progress conv=fsync
sync
```

### Release Types

- **Release (`main` branch)**: Stable, tested images
- **Pre-release (other branches)**: Experimental, development images

### Build Frequency

Images are automatically built:
- On **every push** to any branch
- **Daily** at 2:00 AM UTC (to get latest Debian/RaspiOS updates)
- **Manually** via the GitHub Actions interface

### Release Contents

Each release contains:
- All `.img.xz` files (compressed ready-to-flash images)
- Build information (branch, commit, date)
- Flashing instructions
- Link to build workflow

For more details on the CI/CD workflow, see [`.github/README.md`](.github/README.md).

## Resources

- [Raspberry Pi OS Downloads](https://www.raspberrypi.com/software/operating-systems/)
- [Debian Cloud Images](https://cloud.debian.org/images/cloud/)
- [PiShrink](https://github.com/Drewsif/PiShrink)
- [Cloud-init Documentation](https://cloudinit.readthedocs.io/)
- [QEMU ARM Documentation](https://www.qemu.org/docs/master/system/target-arm.html)

## License

This project is provided "as is" without warranty. Use at your own risk.
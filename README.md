# RPI-Dev - Raspberry Pi Hybrid Image Builder

Automated build system for creating Raspberry Pi images with **Raspberry Pi OS hardware support** + **custom Debian ARM64 rootfs**.

[![Build Images](https://github.com/Pikatsuto/raspberry-builds/actions/workflows/build-images.yml/badge.svg)](https://github.com/Pikatsuto/raspberry-builds/actions/workflows/build-images.yml)
[![License](https://img.shields.io/badge/license-As--Is-blue.svg)](LICENSE)

---

## Why This Project?

The Raspberry Pi uses specialized hardware (RP1 chip) for critical I/O that requires kernel drivers not yet in mainline Linux. This project solves that by:

- âœ… Maintaining **full Raspberry Pi hardware support** (Ethernet, WiFi, GPIO, USB via RP1)
- âœ… Using **pure Debian ARM64** rootfs for a clean, standard environment
- âœ… Enabling **automatic kernel/firmware updates** via APT with proper pinning
- âœ… Supporting **custom image configurations** with automated builds via GitHub Actions

## Quick Start

### For Users: Download Pre-Built Images

1. Go to **[Releases](../../releases)**
2. Download the `.img.xz` file for your desired image
3. Flash to SD card or SSD:

```bash
xz -dc rpi-*.img.xz | sudo dd of=/dev/sdX bs=4M status=progress conv=fsync
sync
```

**âš ï¸ Replace `/dev/sdX` with your actual device (check with `lsblk`)**

### For Developers: Fork and Customize

1. **Fork this repository**
2. **Create your custom image**:
   ```bash
   cp -r images/raspivirt-incus images/my-custom-image
   vim images/my-custom-image/config.sh   # Configure image size, resources
   vim images/my-custom-image/setup.sh    # Add your packages and config
   ```

3. **Customize the setup** (`images/my-image/setup.sh`)
   - Add your packages
   - Configure your services
   - Customize the system

4. **Add your files** (`images/my-image/setupfiles/`)
   - Configurations (.bashrc, .vimrc, etc.)
   - Scripts
   - SSH keys, certificates

5. **Build the image**
   ```bash
   ./bin/autobuild --image my-image
   ```

### Image Structure

Each image in `images/` contains:

```
images/image-name/
â”œâ”€â”€ config.sh       # Configuration (OUTPUT_IMAGE, IMAGE_SIZE, RAM, CPUs)
â”œâ”€â”€ setup.sh        # Script executed at boot in QEMU
â”œâ”€â”€ setupfiles/     # Files copied to /root/setupfiles/ in the image
â””â”€â”€ cloudinit/      # Cloud-init configuration specific to this image
    â”œâ”€â”€ user-data   # Users, SSH, passwords
    â”œâ”€â”€ meta-data   # Hostname, instance-id
    â””â”€â”€ seed.img    # Automatically generated by autobuild
```

### Pre-built Images

This repository includes multiple ready-to-use image variants optimized for different use cases.

#### Base Images

##### RaspiVirt-Incus
**Image**: `raspivirt-qemu`

Base virtualization platform with Incus container/VM manager:
- Incus web UI (port 8443)
- KVM hardware virtualization
- Bridged networking (br-wan + optional br-lan)
- System containers and VMs support

```bash
./bin/autobuild --image raspivirt-qemu
```

**[Full Documentation](wiki/Image-RaspiVirt-Incus.md)**

##### RaspiVirt-Incus+Docker
**Image**: `raspivirt-qemu+docker`

Extends RaspiVirt-Incus with Docker integration:
- Everything from RaspiVirt-Incus
- Docker Engine with Portainer web UI (port 9443)
- Watchtower for automatic container updates
- Run both Incus and Docker workloads

```bash
./bin/autobuild --image raspivirt-qemu+docker
```

**[Full Documentation](wiki/Image-RaspiVirt-Incus-Docker.md)**

##### RaspiVirt-Incus+HAOS
**Image**: `raspivirt-qemu+haos`

Home automation platform with automatic Home Assistant OS deployment:
- Everything from RaspiVirt-Incus
- Home Assistant OS VM (auto-deployed on first boot)
- Adaptive dual-bridge networking (br-lan/br-wan)
- Automatic Zigbee/Z-Wave dongle detection and USB passthrough
- Built-in DHCP/DNS server for LAN (if eth1 detected)

```bash
./bin/autobuild --image raspivirt-qemu+haos
```

**[Full Documentation](wiki/Image-RaspiVirt-Incus-HAOS.md)**

#### WiFi Hotspot Variants

All base images are available with WiFi Access Point functionality:

##### RaspiVirt-Incus+Hotspot
**Image**: `raspivirt-qemu+hotspot`

Base platform + WiFi hotspot (5GHz or dual-band):
- All RaspiVirt-Incus features
- Automatic WiFi interface detection
- hostapd with WPA2 security
- DHCP/DNS server for WiFi clients

```bash
./bin/autobuild --image raspivirt-qemu+hotspot
```

##### RaspiVirt-Incus+Docker+Hotspot
**Image**: `raspivirt-qemu+docker+hotspot`

Incus + Docker + WiFi hotspot

##### RaspiVirt-Incus+HAOS+Hotspot
**Image**: `raspivirt-qemu+haos+hotspot`

Home automation + WiFi hotspot

**[WiFi Hotspot Documentation](wiki/Image-WiFi-Hotspot.md)**

#### HAOS+Docker Variants

Home Assistant images with Docker support:

##### RaspiVirt-Incus+HAOS+Docker
**Image**: `raspivirt-qemu+haos+docker`

Complete home automation platform:
- Home Assistant OS VM
- Docker Engine with Portainer
- Watchtower for updates
- Zigbee/Z-Wave support

```bash
./bin/autobuild --image raspivirt-qemu+haos+docker
```

##### RaspiVirt-Incus+HAOS+Docker+Hotspot
**Image**: `raspivirt-qemu+haos+docker+hotspot`

All-in-one: HAOS + Docker + WiFi hotspot

```bash
./bin/autobuild --image raspivirt-qemu+haos+docker+hotspot
```

**[HAOS+Docker Documentation](wiki/Image-HAOS-Docker.md)**

---

**Complete Image Matrix**:

| Base | +Hotspot | +Docker | +HAOS | +HAOS+Docker | +HAOS+Docker+Hotspot |
|------|----------|---------|-------|--------------|----------------------|
| âœ… Incus | âœ… | âœ… | âœ… | âœ… | âœ… |

### Custom Image Examples

#### Docker Image
```bash
cp -r images/exemple images/docker
# Edit images/docker/setup.sh to add Docker
./bin/autobuild --image docker
```

#### Web Server Image
```bash
cp -r images/exemple images/webserver
# Edit images/webserver/setup.sh to install Nginx
./bin/autobuild --image webserver
```

See `images/README.md` for more details.

## Manual Development Workflow

### 1. Development and Testing in QEMU

Before creating the final Raspberry Pi image, you can develop and test your Debian configuration in QEMU.

#### Launch Debian Image in QEMU

```bash
# Launch QEMU with cloud-init
qemu-system-aarch64 \
    -M virt \
    -cpu cortex-a72 \
    -m 8G \
    -smp 4 \
    -bios /usr/share/edk2/aarch64/QEMU_CODE.fd \
    -drive file=debian-13-backports-genericcloud-arm64-daily.raw,format=raw,if=virtio \
    -drive file=cloudinit/seed.img,format=raw,if=virtio \
    -device virtio-net-pci,netdev=net0 \
    -netdev user,id=net0,hostfwd=tcp::2222-:22 \
    -nographic
```

#### Important QEMU Options

- `-M virt`: Generic ARM virtual machine
- `-cpu cortex-a72`: ARM Cortex-A72 processor (similar to Pi)
- `-m 8G`: 8 GB RAM
- `-smp 4`: 4 CPU cores
- `-bios`: UEFI firmware for ARM64
- `hostfwd=tcp::2222-:22`: Forward SSH from port 2222 (host) to 22 (VM)
- `-nographic`: Console mode (no graphical interface)

#### Connect to the VM

```bash
# Via SSH (once the VM has started)
ssh -p 2222 pi@localhost
```

| Image | Description | Size | Download |
|-------|-------------|------|----------|
| **[RaspiVirt-Incus](../../wiki/Image-RaspiVirt-Incus)** | Incus container/VM manager with KVM, web UI, and br-wan networking | 500 MB | [Latest](../../releases) |
| **[RaspiVirt-Incus+Docker](../../wiki/Image-RaspiVirt-Incus-Docker)** | RaspiVirt-Incus + Docker + Portainer + Watchtower | 700 MB | [Latest](../../releases) |

**[ğŸ“– Full image documentation in the Wiki](../../wiki)**

## Documentation

Complete documentation is available in the **[GitHub Wiki](../../wiki)**:

- **[ğŸ  Home](../../wiki/Home)** - Project overview and quick start
- **[âš™ï¸ GitHub Actions](../../wiki/GitHub-Actions)** - Automated build system documentation
- **[ğŸ“¦ RaspiVirt-Incus](../../wiki/Image-RaspiVirt-Incus)** - Incus virtualization platform
- **[ğŸ³ RaspiVirt-Incus+Docker](../../wiki/Image-RaspiVirt-Incus-Docker)** - Incus + Docker platform

## How It Works

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Download Base Images (RaspiOS + Debian)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. QEMU Setup (Native ARM64)                                â”‚
â”‚    - Execute setup.sh in QEMU                               â”‚
â”‚    - Install RaspiOS kernel/firmware via APT                â”‚
â”‚    - Install custom packages and configuration              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Merge (Partition-level)                                  â”‚
â”‚    - Keep RaspiOS boot partition (firmware)                 â”‚
â”‚    - Replace root partition with configured Debian          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. Compress with PiShrink                                   â”‚
â”‚    - Shrink filesystem and compress to .xz                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**[ğŸ“– See detailed architecture in the Wiki](../../wiki/Home#how-it-works)**

## Building Locally

Install dependencies:
```bash
sudo apt install -y qemu-system-aarch64 qemu-utils parted \
    e2fsprogs dosfstools rsync xz-utils genisoimage
```

Build an image:
```bash
# Build specific image
./bin/autobuild --image raspivirt-incus

# Build all images
./bin/autobuild --all-images

# List available images
./bin/autobuild --list-images
```

**[ğŸ“– See full build documentation in the Wiki](../../wiki/Home#building-locally)**

## Features

### Automated CI/CD
- âœ… **Daily builds** at 2:00 AM UTC with latest base images
- âœ… **Automatic releases** on push to main branch
- âœ… **Parallel builds** for multiple images
- âœ… **Pre-release testing** on feature branches

**[ğŸ“– See GitHub Actions documentation](../../wiki/GitHub-Actions)**

### Hardware Support
- âœ… Gigabit Ethernet (RP1)
- âœ… WiFi + Bluetooth
- âœ… GPIO (40 pins)
- âœ… USB 3.0 (RP1)
- âœ… PCIe (M.2 SSD)
- âœ… HDMI (dual 4K)
- âœ… Camera/DSI/CSI
- âœ… Hardware acceleration

### System Updates
Automatic kernel and firmware updates via APT:
```bash
sudo apt update && sudo apt upgrade -y
```

APT pinning ensures RaspiOS packages (kernel/firmware) update from RaspiOS repository while keeping Debian userspace packages from Debian.

## Project Structure

```
rpi-dev/
â”œâ”€â”€ bin/
â”‚   â”œâ”€â”€ autobuild                 # Automated build script
â”‚   â””â”€â”€ merge-debian-raspios.sh   # Merge script
â”œâ”€â”€ images/                       # Image configurations
â”‚   â”œâ”€â”€ raspivirt-incus/
â”‚   â””â”€â”€ raspivirt-incus+docker/
â”œâ”€â”€ wiki/                         # Wiki documentation (auto-synced)
â””â”€â”€ .github/
    â””â”€â”€ workflows/
        â”œâ”€â”€ build-images.yml      # Multi-stage build workflow
        â””â”€â”€ sync-wiki.yml         # Wiki synchronization
```

## Creating Custom Images

1. **Copy an existing image template**:
   ```bash
   cp -r images/raspivirt-incus images/my-image
   ```

2. **Configure** (`images/my-image/config.sh`):
   - `OUTPUT_IMAGE`: Filename
   - `IMAGE_SIZE`: Final size (e.g., "8G")
   - `QEMU_RAM`, `QEMU_CPUS`: Build resources

3. **Customize** (`images/my-image/setup.sh`):
   - Add package installations
   - Configure services
   - Apply custom settings

4. **Add files** to `setupfiles/`:
   - Configuration files
   - Scripts
   - Certificates

5. **Build**:
   ```bash
   ./bin/autobuild --image my-image
   ```

**[ğŸ“– See detailed customization guide in the Wiki](../../wiki/Home#creating-custom-images)**

## Releases

Pre-built images are automatically released via GitHub Actions:

- **Stable releases** (main branch) - Production-ready
- **Pre-releases** (other branches) - Experimental/testing
- **Daily builds** - Latest Debian/RaspiOS updates

**[â¬‡ï¸ Download from Releases](../../releases)**

## Technical Details

- **Base OS**: Debian 13 (Trixie) ARM64
- **Kernel**: Raspberry Pi OS kernel (latest)
- **Build System**: GitHub Actions with 4-stage pipeline
- **Boot Mode**: Cloud-init or first-boot systemd service
- **Package Management**: APT with repository pinning

**[ğŸ“– See CLAUDE.md for complete technical documentation](CLAUDE.md)**

## Resources

- **[ğŸ“– Wiki](../../wiki)** - Complete documentation
- **[ğŸ“¦ Releases](../../releases)** - Download pre-built images
- **[ğŸ”§ Issues](../../issues)** - Report bugs or request features
- **[ğŸš€ Actions](../../actions)** - View build status

### External Links
- [Raspberry Pi OS Downloads](https://www.raspberrypi.com/software/operating-systems/)
- [Debian Cloud Images](https://cloud.debian.org/images/cloud/)
- [Incus Documentation](https://linuxcontainers.org/incus/)
- [Docker Documentation](https://docs.docker.com/)

## Contributing

Contributions are welcome! To contribute:

1. Fork the repository
2. Create a feature branch
3. Make your changes
4. Test locally with `./bin/autobuild`
5. Submit a pull request

## License

This project is provided "as is" without warranty. Use at your own risk.

---

**Made with â¤ï¸ for the Raspberry Pi community**
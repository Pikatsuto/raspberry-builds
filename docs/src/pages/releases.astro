---
import StarlightPage from '@astrojs/starlight/components/StarlightPage.astro';
import ReleasesComponent from '../components/ReleasesComponent.vue';

// Fetch releases at build time for SEO
let releases: any[] = [];
try {
  const response = await fetch('https://api.github.com/repos/Pikatsuto/raspberry-builds/releases');
  if (response.ok) {
    releases = await response.json();
  }
} catch (error) {
  console.error('Failed to fetch releases at build time:', error);
}

// Filter stable releases
const stableReleases = releases.filter((r: any) => !r.prerelease).slice(0, 5);
---

<StarlightPage
  frontmatter={{
    title: 'Stable Releases',
    description: 'Download official stable Raspberry Pi hybrid images with Raspberry Pi OS hardware support and custom Debian ARM64 rootfs',
  }}
>
  <div class="releases-intro">
    <p>
      Download official stable Raspberry Pi hybrid images that have been thoroughly tested
      and are recommended for everyday use. Each release combines Raspberry Pi OS hardware
      support with a custom Debian ARM64 rootfs, providing full hardware compatibility while
      maintaining a clean Debian environment.
    </p>

    <h2>Available Images</h2>
    <p>
      All images are compressed with PiShrink and ready to flash to your SD card or SSD.
      Check the individual image documentation for detailed installation and usage instructions.
    </p>
  </div>

  <!-- Static content for SEO -->
  {stableReleases.length > 0 && (
    <div class="seo-releases">
      {stableReleases.map((release: any) => (
        <div>
          <h3>{release.tag_name} - {release.name}</h3>
          <p>Released: {new Date(release.published_at).toLocaleDateString()}</p>
          {release.assets && release.assets.length > 0 && (
            <ul>
              {release.assets.map((asset: any) => (
                <li>
                  <a href={asset.browser_download_url}>{asset.name}</a>
                  ({(asset.size / 1024 / 1024).toFixed(2)} MB)
                </li>
              ))}
            </ul>
          )}
        </div>
      ))}
    </div>
  )}

  <!-- Interactive component (client-side) -->
  <ReleasesComponent client:load prerelease={false} limit={10} />

  <div class="flash-instructions">
    <h2>Flash an Image</h2>
    <pre><code># Decompress and flash
xz -dc rpi-*.img.xz | sudo dd of=/dev/sdX bs=4M status=progress conv=fsync
sync</code></pre>
    <p><strong>⚠️ Replace <code>/dev/sdX</code> with your device!</strong></p>
  </div>

  <div class="github-link">
    <a href="https://github.com/Pikatsuto/raspberry-builds/releases" target="_blank" rel="noopener noreferrer">
      View all releases on GitHub →
    </a>
  </div>
</StarlightPage>

<style>
  .releases-intro {
    margin-bottom: 2rem;
  }

  .seo-releases {
    display: none; /* Hidden from view but crawlable by search engines */
  }

  .flash-instructions {
    margin-top: 3rem;
    padding: 1.5rem;
    background: var(--sl-color-gray-6);
    border-radius: 0.5rem;
  }

  .flash-instructions h2 {
    margin-top: 0;
  }

  .flash-instructions pre {
    margin: 1rem 0;
  }

  .github-link {
    margin-top: 2rem;
    text-align: center;
  }

  .github-link a {
    color: var(--sl-color-accent);
    text-decoration: none;
    font-weight: 500;
  }

  .github-link a:hover {
    text-decoration: underline;
  }
</style>